<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recepción Técnica | Sievert LCD</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --brand-purple: #52277c;
            --brand-purple-dark: #3a1b59;
            --brand-red: #e43d30;
            --success: #10b981;
            --error: #ef4444;
            --text-main: #2d3748;
            --text-light: #718096;
            --bg-page: #f0f2f5;
            --input-bg: #f8fafc;
            --border-color: #e2e8f0;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-page);
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
            margin: 0; padding: 40px 20px; 
            color: var(--text-main);
            min-height: 100vh;
            display: flex; justify-content: center;
        }

        .main-container {
            width: 100%; max-width: 1100px;
            background: white; border-radius: 16px;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
            overflow: hidden; border: 1px solid rgba(255,255,255,0.5);
            display: flex; flex-direction: column;
        }

        /* Header */
        .hero-header {
            background: linear-gradient(135deg, var(--brand-purple) 0%, var(--brand-purple-dark) 100%);
            color: white; padding: 40px; text-align: center; position: relative;
        }
        .hero-header img { height: 60px; filter: brightness(0) invert(1); margin-bottom: 15px; }
        .hero-title { font-family: 'Poppins', sans-serif; font-size: 1.6rem; margin: 0 0 15px 0; font-weight: 600; line-height: 1.3; }
        .hero-subtitle { 
            font-size: 0.9rem; opacity: 0.95; max-width: 800px; margin: 0 auto; line-height: 1.6; font-weight: 300; text-align: justify; text-align-last: center; 
        }
        .hero-subtitle strong { font-weight: 600; color: #ffd700; }

        /* Formulario */
        .form-content { padding: 40px 40px 20px 40px; } 
        .section-block { margin-bottom: 40px; position: relative; }
        
        .section-header {
            display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
            padding-bottom: 10px; border-bottom: 2px solid var(--bg-page);
        }
        .section-icon {
            width: 32px; height: 32px; background: rgba(82, 39, 124, 0.1);
            color: var(--brand-purple); border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
        }
        .section-title { font-family: 'Poppins', sans-serif; font-size: 1.1rem; font-weight: 600; color: var(--brand-purple); margin: 0; }

        /* Grid */
        .input-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; }
        .col-12 { grid-column: span 12; } .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; } .col-4 { grid-column: span 4; } .col-3 { grid-column: span 3; }

        /* Inputs */
        .form-group { position: relative; }
        .form-label { display: block; margin-bottom: 6px; font-size: 0.85rem; font-weight: 500; color: var(--text-light); }
        .form-control {
            width: 100%; padding: 10px 12px; border-radius: 8px;
            border: 1px solid var(--border-color); background-color: var(--input-bg);
            color: var(--text-main); font-family: inherit; font-size: 0.9rem;
            transition: all 0.2s ease; box-sizing: border-box;
        }
        .form-control:focus { outline: none; background-color: white; border-color: var(--brand-purple); box-shadow: 0 0 0 4px rgba(82, 39, 124, 0.1); }
        .form-control.is-invalid { border-color: var(--error); background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ef4444'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; animation: shake 0.3s; }
        .error-msg { color: var(--error); font-size: 0.75rem; margin-top: 4px; display: none; }
        .form-control.is-invalid + .error-msg { display: block; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }

        /* Tabla y Counter */
        .counter-box { background: #f8fafc; border: 1px solid var(--border-color); padding: 20px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; max-width: 400px; }
        .qty-input { width: 80px; text-align: center; font-weight: 700; color: var(--brand-purple); font-size: 1.2rem; }
        
        .table-wrapper { margin-top: 25px; border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; display: none; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f1f5f9; text-align: left; padding: 12px; font-size: 0.8rem; text-transform: uppercase; color: var(--text-light); font-weight: 600; }
        td { padding: 8px; border-bottom: 1px solid var(--border-color); background: white; vertical-align: top; }
        td .form-control { padding: 8px; font-size: 0.85rem; }

        /* Alert Box */
        .alert-box {
            background: #fffbeb; border: 1px solid #fcd34d; color: #92400e;
            padding: 15px; border-radius: 8px; font-size: 0.9rem; margin-top: 20px;
            display: flex; gap: 10px; align-items: start;
        }
        .alert-box i { color: #d97706; margin-top: 3px; }

        /* Botones */
        .btn-submit { background: linear-gradient(to right, var(--brand-purple), #6b3fa0); color: white; border: none; padding: 14px 40px; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(82, 39, 124, 0.3); transition: all 0.3s; display: inline-flex; align-items: center; gap: 10px; }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(82, 39, 124, 0.4); }
        .btn-submit-container { margin-top: 40px; text-align: right; border-top: 1px solid var(--border-color); padding-top: 30px; }
        .btn-icon-trash { color: #ef4444; background: #fee2e2; width: 30px; height: 30px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        
        .autosave-badge { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; opacity: 0; transition: opacity 0.5s; }
        
        /* FOOTER CON FIRMA */
        .signature-footer {
            background: #fdfdfd;
            border-top: 1px solid #eee;
            padding: 40px 20px;
            text-align: center;
            margin-top: auto; 
        }
        .sig-line {
            width: 50px; height: 3px; background: var(--brand-purple); 
            margin: 0 auto 15px auto; border-radius: 2px; opacity: 0.7;
        }
        .sig-name { color: var(--brand-purple); font-weight: 700; font-size: 1.2rem; margin: 0; }
        .sig-role { color: #4a5568; font-size: 0.95rem; margin: 5px 0 10px 0; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .sig-contact { color: #718096; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 8px;}
        .whatsapp-link {
            color: #25d366; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 5px;
            background: #f0fdf4; padding: 5px 12px; border-radius: 20px; transition: 0.2s;
        }
        .whatsapp-link:hover { background: #dcfce7; color: #16a34a; }

        /* ESTILOS PARA LA NOTA AMARILLA */
        .instruction-box {
            background: #fffbeb; border-left: 5px solid #f59e0b; padding: 25px; 
            margin-bottom: 30px; border-radius: 0 8px 8px 0;
        }
        .instruction-title { color: #92400e; font-weight: 700; margin-bottom: 15px; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .instruction-list { padding-left: 20px; margin: 0; color: #78350f; font-size: 0.9rem; line-height: 1.6; }
        .instruction-list li { margin-bottom: 8px; }
        
        /* Enlace de soporte dentro de la nota amarilla */
        .support-link {
            margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(146, 64, 14, 0.2);
            color: #92400e; font-size: 0.9rem;
        }
        .whatsapp-btn-inline {
            color: #16a34a; font-weight: 700; text-decoration: none; display: inline-flex; align-items: center; gap: 5px;
            background: rgba(37, 211, 102, 0.1); padding: 2px 8px; border-radius: 4px; transition: 0.2s;
        }
        .whatsapp-btn-inline:hover { background: rgba(37, 211, 102, 0.2); }

    </style>
</head>
<body>

<datalist id="lista_marcas">
    <option value="Ludlum"><option value="Fluke"><option value="RaySafe"><option value="Atomtex"><option value="Radiation Alert"><option value="SE International"><option value="Arrow Tech"><option value="Stephen"><option value="Panasonic"><option value="Landauer"><option value="BeOSL"><option value="CNMC"><option value="WB Johnson"><option value="Victoreen"><option value="Tracerco"><option value="Biodex"><option value="Eberline"><option value="Mirion"><option value="Ecotest"><option value="ECCI"><option value="Berthold"><option value="Innovision"><option value="Thermo"><option value="RAE Systems"><option value="GQ"><option value="Mazur"><option value="Rados"><option value="DKG"><option value="Smach">
</datalist>

<datalist id="lista_modelos">
    <option value="14C"><option value="14C + 44-7"><option value="14C + 44-9"><option value="14C + 44-10"><option value="14C + 44-38"><option value="3 + 44-6"><option value="3 + 44-7"><option value="3 + 44-9"><option value="9DP"><option value="23-1"><option value="25-1"><option value="25-IS-1"><option value="26-1"><option value="177 + 44-25"><option value="177 + 44-26"><option value="177-10 + 44-26"><option value="300 + 44-9"><option value="375"><option value="375-2"><option value="375-4"><option value="375 + 44-11"><option value="376"><option value="702"><option value="2401-P"><option value="3000 + 44-9"><option value="3001"><option value="3001 + 44-9"><option value="3003 + 43-93"><option value="3003i + 44-9"><option value="3276"><option value="3276 + 44-10"><option value="3276 + 44-25"><option value="3276 + 44-26"><option value="AT6130"><option value="AT6130D"><option value="AT6131"><option value="AT2140A"><option value="AT2503A"><option value="451P"><option value="451B"><option value="451B-DE-SI-RYR"><option value="ASM993"><option value="Primalert 10 (05-433)"><option value="Primalert 35 (05-437)"><option value="Primalert (05-473)"><option value="Victoreen 190 + 489-110D"><option value="Victoreen 450B"><option value="RaySafe 452"><option value="Ranger"><option value="Inspector"><option value="Inspector+"><option value="Inspector EXP + RAP-RS1"><option value="Monitor 4"><option value="Monitor 4EC"><option value="Monitor 5"><option value="W138"><option value="W500"><option value="883M"><option value="UD802"><option value="InLight OSL"><option value="BeOSL"><option value="7008 R/T"><option value="DSM-503"><option value="TBM-3"><option value="RAD-60R"><option value="PED+ / T414-2"><option value="T414-4"><option value="SM #069-310"><option value="E-120E + HP-260"><option value="RadEye B20"><option value="RadEye B20-ER"><option value="RadEye G10"><option value="RadEye PRD"><option value="RadEye SX"><option value="EPD MK2+"><option value="EPD TruDose"><option value="GammaRAE IIR"><option value="GMC-500+"><option value="GMC-800"><option value="MCA-LITE"><option value="R-EGD"><option value="COMO170"><option value="ND-2000C"><option value="TERRA-P"><option value="DKG-21"><option value="200 MP"><option value="RD-30"><option value="PRIM-9000">
</datalist>

<div class="main-container">
    <div class="hero-header">
        <div class="autosave-badge" id="autosaveBadge"><i class="fa-solid fa-cloud-arrow-up"></i> Guardado</div>
        <div class="logo-container">
            <img src="{{ url_for('static', filename='img/Logo_LCD.png') }}" alt="Sievert LCD Logo">
        </div>
        <h1 class="hero-title">Recomendaciones y mediciones para el despacho de tus instrumentos</h1>
        <p class="hero-subtitle">
            Por favor registre las mediciones de contaminación superficial de sus equipos antes del despacho. Este requisito es <strong>OBLIGATORIO </strong> para gestionar la recolección y garantizar un manejo seguro en nuestro laboratorio.
        </p>
    </div>

    <form id="techForm" class="form-content" novalidate>
        
        <div class="section-block">
            <div class="section-header">
                <div class="section-icon"><i class="fa-solid fa-building-user"></i></div>
                <h3 class="section-title">Datos del Cliente</h3>
            </div>
            
            <div class="input-grid">
                <div class="form-group col-8">
                    <label class="form-label">Razón Social / Institución</label>
                    <input type="text" name="cliente" class="form-control" oninput="saveDraft()">
                    <div class="error-msg">Ingrese un nombre válido.</div>
                </div>
                <div class="form-group col-4">
                    <label class="form-label">NIT</label>
                    <input type="text" name="nit" class="form-control" inputmode="numeric" required placeholder="Solo números" oninput="validateNumber(this); saveDraft()">
                    <div class="error-msg">Solo números.</div>
                </div>
                
                <div class="form-group col-8">
                    <label class="form-label">Correo Electrónico</label>
                    <input type="email" name="email" class="form-control" required placeholder="ejemplo@empresa.com" oninput="saveDraft()">
                    <div class="error-msg">Ingrese un correo válido.</div>
                </div>
                
                <div class="form-group col-4">
                    <label class="form-label">Teléfono / Celular</label>
                    <input type="tel" name="telefono" class="form-control" inputmode="tel" required placeholder="Ej: 3001234567" oninput="validatePhone(this); saveDraft()">
                </div>

                <div class="form-group col-8">
                    <label class="form-label">Dirección de Recolección</label>
                    <input type="text" name="direccion" class="form-control" required oninput="saveDraft()">
                </div>
                <div class="form-group col-4">
                    <label class="form-label">Ciudad</label>
                    <input type="text" name="ciudad" class="form-control" required oninput="validateText(this); saveDraft()">
                    <div class="error-msg">Solo letras.</div>
                </div>
                
                <div class="form-group col-6">
                    <label class="form-label">Responsable de Medición</label>
                    <input type="text" name="responsable_medicion" class="form-control" required oninput="validateText(this); saveDraft()">
                </div>
                <div class="form-group col-6">
                    <label class="form-label">Cargo</label>
                    <input type="text" name="cargo" class="form-control" required oninput="saveDraft()">
                </div>
            </div>
        </div>

        <div class="instruction-box">
            <div class="instruction-title"><i class="fa-solid fa-list-check"></i> Indicaciones de Diligenciamiento:</div>
            <ol class="instruction-list">
                <li><strong>Equipo de Medición:</strong> Las mediciones de contaminación deben realizarse con un instrumento diferente a los que se enviarán a calibrar.</li>
                <li><strong>Registro Individual:</strong> Realice la medición por separado para cada instrumento del despacho y diligencie la información del mismo en </li>
                <li><strong>Detectores Externos:</strong> Si el equipo requiere sonda/detector externo, registre únicamente la información de dicho detector.</li>
                <li><strong>Límite:</strong> El límite de contaminación es establecido por el OPR de su institución.</li>
            </ol>          
        </div>

        <div class="section-block">
            <div class="section-header">
                <div class="section-icon"><i class="fa-solid fa-microscope"></i></div>
                <h3 class="section-title">Instrumento de Referencia</h3>
            </div>
            
            <div class="input-grid">
                <div class="form-group col-4">
                    <label class="form-label">Marca</label>
                    <input type="text" name="ref_marca" class="form-control" list="lista_marcas" required oninput="saveDraft()" placeholder="Seleccione o escriba...">
                </div>
                <div class="form-group col-4">
                    <label class="form-label">Modelo</label>
                    <input type="text" name="ref_modelo" class="form-control" list="lista_modelos" required oninput="saveDraft()" placeholder="Seleccione o escriba...">
                </div>
                <div class="form-group col-4">
                    <label class="form-label">Número de Serie</label>
                    <input type="text" name="ref_serie" class="form-control" required oninput="saveDraft()">
                </div>
            </div>
        </div>

        <div class="section-block">
            <div class="section-header">
                <div class="section-icon"><i class="fa-solid fa-box-open"></i></div>
                <h3 class="section-title">Equipos a Enviar</h3>
            </div>

            <div class="counter-box" style="margin-top: 20px;">
                <div>
                    <strong style="display:block; color: var(--text-main);">Cantidad de Equipos</strong>
                    <span style="font-size: 0.8rem; color: var(--text-light);">¿Cuántos equipos nos enviará?</span>
                </div>
                <input type="number" id="qtyInput" class="form-control qty-input" min="0" value="0" onchange="generateRows()">
            </div>

            <div class="table-wrapper" id="itemsContainer">
                <table id="itemsTable">
                    <thead>
                        <tr>
                            <th width="15%">Marca</th>
                            <th width="15%">Modelo</th>
                            <th width="15%">Serie</th>
                            <th width="10%">Unidad</th>
                            <th width="10%">Fondo</th>
                            <th width="10%">Instrumento</th>
                            <th width="10%">Neto</th>
                            <th width="10%">Límite</th>
                            <th width="5%"></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="btn-submit-container">
            <button type="submit" class="btn-submit">
                <span>Registrar Solicitud</span>
                <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </form>

    <div class="signature-footer">
        <div class="sig-line"></div>
        <p class="sig-name">Diana Ortegón Pineda</p>
        <p class="sig-role">Coordinadora LCD</p>
        
        <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 15px;">
            <span style="color: #718096; font-size: 0.95rem;">
                (+57) 317 638 8661 - 310 564 3619
            </span>

            <a href="https://wa.me/573176388661" target="_blank" title="Clic para chatear en WhatsApp" style="text-decoration: none;">
                <i class="fa-brands fa-whatsapp" 
                   style="font-size: 2.8rem; color: #25d366; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); transition: transform 0.2s;"
                   onmouseover="this.style.transform='scale(1.15)'" 
                   onmouseout="this.style.transform='scale(1)'">
                </i>
            </a>
        </div>
    </div>
</div>

<script>
    // --- VALIDACIONES ---
    function validateNumber(input) {
        input.value = input.value.replace(/[^0-9]/g, ''); 
        validateField(input, input.value.length > 5); 
    }
    function validatePhone(input) {
        input.value = input.value.replace(/[^0-9+ ]/g, '');
        validateField(input, input.value.length > 6);
    }
    function validateText(input) {
        input.value = input.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '');
        validateField(input, input.value.length > 2);
    }
    function validateField(input, isValid) {
        if (isValid) { input.classList.remove('is-invalid'); input.classList.add('is-valid'); }
        else { input.classList.remove('is-valid'); input.classList.add('is-invalid'); }
    }

    // --- AUTOSAVE ---
    function saveDraft() {
        const formData = new FormData(document.getElementById('techForm'));
        const data = {};
        formData.forEach((value, key) => { if(!key.includes('[]')) data[key] = value; });
        localStorage.setItem('sievert_draft', JSON.stringify(data));
        const badge = document.getElementById('autosaveBadge');
        badge.style.opacity = '1';
        setTimeout(() => badge.style.opacity = '0', 2000);
    }
    function loadDraft() {
        const saved = localStorage.getItem('sievert_draft');
        if (saved) {
            const data = JSON.parse(saved);
            for (const key in data) {
                const input = document.querySelector(`[name="${key}"]`);
                if (input) input.value = data[key];
            }
        }
    }

    // --- TABLA ---
    function generateRows() {
        const qty = parseInt(document.getElementById('qtyInput').value) || 0;
        const container = document.getElementById('itemsContainer');
        const tbody = document.getElementById('tableBody');

        if (qty > 0) container.style.display = 'block';
        else { container.style.display = 'none'; tbody.innerHTML = ''; return; }

        const currentRows = tbody.rows.length;
        if (qty > currentRows) {
            for (let i = 0; i < (qty - currentRows); i++) addRow();
        } else if (qty < currentRows) {
            for (let i = 0; i < (currentRows - qty); i++) tbody.deleteRow(tbody.rows.length - 1);
        }
    }

    function addRow() {
        const tbody = document.getElementById('tableBody');
        const row = tbody.insertRow();
        
        row.innerHTML = `
            <td>
                <input type="text" name="marca[]" list="lista_marcas" class="form-control" required placeholder="Marca">
            </td>
            <td>
                <input type="text" name="modelo[]" list="lista_modelos" class="form-control" required placeholder="Modelo">
            </td>
            <td><input type="text" name="serie[]" class="form-control" required placeholder="S/N"></td>
            <td>
                <select name="unidad[]" class="form-control" onchange="calcNet(this)">
                    <option value="CPM">CPM</option>
                    <option value="CPS">CPS</option>
                    <option value="uSv/h">uSv/h</option>
                    <option value="mSv/h">mSv/h</option>
                    <option value="Bq">Bq</option>
                </select>
            </td>
            <td><input type="number" step="any" name="fondo[]" class="form-control" required oninput="calcNet(this); validatePositive(this)" placeholder="0"></td>
            <td><input type="number" step="any" name="inst[]" class="form-control" required oninput="calcNet(this); validatePositive(this)" placeholder="0"></td>
            <td><input type="text" name="neto[]" class="form-control" readonly style="background:#f1f5f9; font-weight:600; color:var(--brand-purple);"></td>
            <td><input type="number" step="any" name="limite[]" class="form-control" required placeholder="Límite"></td>
            <td style="text-align:center;">
                <button type="button" class="btn-icon-trash" onclick="removeRowManual(this)"><i class="fa-solid fa-trash-can"></i></button>
            </td>
        `;
    }

    function validatePositive(input) { if(input.value < 0) input.value = 0; }
    
    function removeRowManual(btn) {
        const row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
        document.getElementById('qtyInput').value = document.getElementById('tableBody').rows.length;
        if(document.getElementById('tableBody').rows.length === 0) document.getElementById('itemsContainer').style.display = 'none';
    }

    function calcNet(input) {
        const row = input.parentNode.parentNode;
        const fondo = parseFloat(row.querySelector('input[name="fondo[]"]').value) || 0;
        const inst = parseFloat(row.querySelector('input[name="inst[]"]').value) || 0;
        const netoInput = row.querySelector('input[name="neto[]"]');
        netoInput.value = Math.round((inst - fondo) * 1000) / 1000;
    }

    window.onload = loadDraft;

    // --- ENVÍO ---
    document.getElementById('techForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const qty = parseInt(document.getElementById('qtyInput').value) || 0;
        if (qty === 0) { Swal.fire({ icon: 'warning', title: 'Atención', text: 'Debe ingresar al menos un equipo.' }); return; }
        if (!e.target.checkValidity()) { 
            e.target.classList.add('was-validated'); 
            Swal.fire({ icon: 'error', title: 'Campos incompletos', text: 'Por favor revise los campos marcados en rojo.' }); 
            return; 
        }

        const btn = document.querySelector('.btn-submit');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Procesando...';
        btn.disabled = true;

        const formData = new FormData(e.target);
        const basicData = Object.fromEntries(formData.entries());
        basicData.fecha_solicitada = new Date().toISOString();
        
        ['marca[]', 'modelo[]','serie[]','unidad[]','fondo[]','inst[]','neto[]','limite[]'].forEach(k => delete basicData[k]);

        const items = [];
        for (let row of document.getElementById('tableBody').rows) {
            items.push({
                marca: row.querySelector('input[name="marca[]"]').value,
                modelo: row.querySelector('input[name="modelo[]"]').value,
                serie: row.querySelector('input[name="serie[]"]').value,
                unidad: row.querySelector('select[name="unidad[]"]').value,
                fondo: row.querySelector('input[name="fondo[]"]').value,
                instrumento: row.querySelector('input[name="inst[]"]').value,
                neto: row.querySelector('input[name="neto[]"]').value,
                limite: row.querySelector('input[name="limite[]"]').value
            });
        }

        try {
            const response = await fetch('/api/public/guardar-despacho', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ...basicData, items })
            });

            if (response.ok) {
                localStorage.removeItem('sievert_draft'); 
                
                Swal.fire({
                    width: '900px',
                    padding: '2.5rem',
                    background: '#ffffff',
                    html: `
                        <style>
                            .success-title { color: #52277c; font-size: 2rem; font-weight: 700; margin: 0; }
                            .success-subtitle { color: #718096; font-size: 1.1rem; margin-top: 5px; }
                            
                            .rec-box { 
                                background: #f8fafc; padding: 30px; border-radius: 16px; 
                                border: 1px solid #e2e8f0; margin-top: 25px; 
                            }
                            .rec-badge { 
                                background: #52277c; color: white; padding: 8px 25px; border-radius: 30px; 
                                font-weight: 600; font-size: 0.9rem; letter-spacing: 1px;
                                box-shadow: 0 4px 10px rgba(82, 39, 124, 0.2); margin-bottom: 25px; display: inline-block;
                            }

                            .steps-container {
                                display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;
                            }

                            .step-card { 
                                background: white; padding: 20px 15px; border-radius: 12px; 
                                border: 1px solid #e2e8f0; text-align: center;
                                width: 28%; min-width: 200px;
                                box-shadow: 0 2px 5px rgba(0,0,0,0.02);
                                transition: transform 0.2s;
                            }
                            .step-card:hover { transform: translateY(-5px); border-color: #52277c; }
                            
                            .step-icon { color: #e43d30; font-size: 2.5rem; margin-bottom: 15px; display: block; }
                            .step-num { font-weight: 700; color: #52277c; font-size: 0.95rem; display: block; margin-bottom: 8px; text-transform: uppercase; }
                            .step-text { font-size: 0.85rem; color: #4a5568; line-height: 1.4; }

                            .step-card:nth-last-child(-n+2) { margin-top: 15px; width: 35%; }
                        </style>

                        <div>
                            <h2 class="success-title"><i class="fa-solid fa-circle-check" style="color:#10b981;"></i> ¡Registro Exitoso!</h2>
                            <p class="success-subtitle">Hemos recibido los datos de <strong>${items.length}</strong> equipos correctamente.</p>
                        </div>

                        <div class="rec-box">
                            <div class="rec-badge"><i class="fa-solid fa-shield-halved"></i> RECOMENDACIONES DE EMPAQUE</div>
                            
                            <div class="steps-container">
                                <div class="step-card">
                                    <i class="step-icon fa-solid fa-box-archive"></i>
                                    <span class="step-num">1. Estado de Caja</span>
                                    <span class="step-text">Usa caja idealmente de doble pared sin daños ni etiquetas anteriores.</span>
                                </div>
                                <div class="step-card">
                                    <i class="step-icon fa-solid fa-maximize"></i>
                                    <span class="step-num">2. Tamaño Adecuado</span>
                                    <span class="step-text">La caja debe ser mín. <strong>8 cm más grande</strong> que el instrumento.</span>
                                </div>
                                <div class="step-card">
                                    <i class="step-icon fa-solid fa-layer-group"></i>
                                    <span class="step-num">3. Relleno Seguro</span>
                                    <span class="step-text">Usa espuma, burbuja o papel de periódico y centra el equipo dentro de la caja.</span>
                                </div>

                                <div class="step-card">
                                    <i class="step-icon fa-solid fa-tape"></i>
                                    <span class="step-num">4. Sellado en H</span>
                                    <span class="step-text">Cierra firmemente con cinta tanto en la parte superior como inferior (método de precinto en forma de H).</span>
                                </div>
                                <div class="step-card">
                                    <i class="step-icon fa-solid fa-clipboard-check"></i>
                                    <span class="step-num">5. Rótulo Visible</span>
                                    <span class="step-text">Pega en la parte superior el rótulo con los datos de remitente y destinatario que te envía <strong>Daiana Monroy.<strong></span>
                                </div>
                            </div>
                        </div>
                    `,
                    showConfirmButton: true,
                    confirmButtonText: 'Entendido, Finalizar',
                    confirmButtonColor: '#52277c',
                    allowOutsideClick: false
                }).then(() => location.reload());
            } else { throw new Error('Error en el servidor'); }
        } catch (error) {
            Swal.fire('Error', 'No se pudo registrar. Intente nuevamente.', 'error');
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    });
</script>

</body>
</html>